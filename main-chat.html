<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Yackity-Yack</title>
        <link rel="stylesheet" href="./resources/main.css">
    </head>
    <body>
        <div class="container">
            <div id="chatWindow"></div>
            <div class="inputdiv">
                <input type="text" name="username" id="msgField" value="" placeholder="Enter a message">
                <div class="submit" id="send"><span>SEND</span></div>
            </div>
        </div>

        <script type="text/javascript">
            var username = localStorage.getItem('userName') || undefined;

            function webSocketInit() {
                if ("WebSocket" in window) {
                    const sendButton = document.getElementById('send');
                    const msgEntry = document.getElementById('msgField');
                    const bodyText = document.getElementById('chatWindow');
                    const socketAddy = 'ws://10.2.61.94:7899'
                    ws = new WebSocket(socketAddy);

                    ws.onopen = function() {
                        console.log('Connected to chat');
                    }

                    ws.onclose = function() {
                        console.log("Chat connection has closed");
                    }



                    ws.onmessage = function(msg){
                        console.log('Chat message recieved',msg);
                        msg = JSON.parse(msg.data);

                        let parentDiv = document.createElement("div");
                        let nameDiv = document.createElement("div");
                        let msgDiv = document.createElement("div");
                        let message = document.createTextNode(msg.message);
                        let name = document.createTextNode(msg.user);
                        parentDiv.className = 'parent';
                        nameDiv.className = 'name';
                        msgDiv.className = 'msg';
                        nameDiv.setAttribute("style", 'color: rgb(' + msg.color[0] + ',' + msg.color[1] + ',' + msg.color[2] + ');');
                        debugger
                        msgDiv.appendChild(message);
                        nameDiv.appendChild(name);
                        parentDiv.appendChild(nameDiv);
                        parentDiv.appendChild(msgDiv);
                        bodyText.appendChild(parentDiv);
                        updateScroll();
                    }

                    const send_msg = function(message){
                        ws.send(message);
                    }



                    sendButton.onmouseup = function(){
                        let data = {};
                        data.message = msgEntry.value.trim();
                        if (!username){
                            username = localStorage.getItem('userName');
                        }
                        data.user = username;
                        if (data.message) {
                            ws.send(JSON.stringify(data));
                        }
                        msgEntry.value = '';
                        msgEntry.focus();
                    }
                }
            }

            document.addEventListener("DOMContentLoaded", function(event) {
                webSocketInit();
            });

            function updateScroll(){
                var element = document.getElementById("chatWindow");
                element.scrollTop = element.scrollHeight;
            }

        </script>
    </body>
</html>
